---
title: 浅谈 JVM：类加载
date: 2021-03-13
categories:
  - 折腾记录
tags:
  - 浅谈
  - JVM
---

## 类加载

Java 虚拟机把描述类的数据从数据源（通常是 Class 文件）加载到内存，并对其校验、解析和初始化，最终生成 Java 可以使用的 Java 类型，这个过程被称为类加载。

### 类

在 Java 中类一般分为 4 种：普通类（以下均简称为类）、接口、数组类、泛型参数。其中由于 Java 会对泛型进行擦除，所以实际上到 JVM 中，类就只剩下前面三种。

在 Java 中数组类是由 JVM 直接生成的，而接口和类都需要从直接流中读取，当然这里的直接流不一定是来自 Class 文件的，也可以是生成的或者网络等其他环境。

### 流程

类加载的过程一般分为以下几步：

1. 加载
2. 链接
3. 初始化

#### 加载

**加载（Loading）**，就是把字节码从各种来源通过类加载器装载到 JVM 的过程。

字节码的来源有许多种，最常见的是通过 class 文件或者 jar 包中读取，也可以在 JVM 中生成（如数组类），或者从网络中加载。只要符合字节码的规范，同时类加载器支持的话就可以完成加载。当输入的数据不是 `ClassFile` 则会抛出 `ClassFormatError`。

#### 链接

**链接（Linking）**，就是将加载完成类合并到 JVM 中，使之可以被执行的过程。

链接有以下三个子步骤：

1. 验证
2. 准备
3. 解析

#### 验证

**验证（Verification）**，这是虚拟机安全的重要保障，JVM 需要核验字节信息是符合 Java 虚拟机规范的，这样就防止了恶意信息或者不合规的信息危害 JVM 的运行，验证阶段有可能触发更多 Class 的加载。

校验的过程大致分为 4 个部分：

1. 文件格式验证：校验字节流是否符合 Class 文件规范。验证内容包括是否以 `0xCAFEBABE` 魔数开头。主、次版本号是否在当前虚拟机的处理范围之内。常量池中的常量类型是否有不支持的。等等。
2. 元数据验证：对字节码描述的信息进行语义分析，以保证其描述的信息符合 Java 语言规范的要求。验证内容包括是否实现了接口，接口的方法是否都被实现了，是否继承自 `final` 标注的类等等。
3. 字节码验证：通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。验证的内容包括类型转换是否有效，跳转是否有效等等。
4. 符号引用验证：该验证在符号引用转换为直接引用的时候（解析阶段）进行校验，验证是否通过符号引用验证指向的实际引用是否有效。

#### 准备

**准备（Preparation）**，准备阶段则是为类的静态字段分配内存。除了分配内存外，部分虚拟机还会在此阶段构造其他跟类相关数据结构，如实现虚方法的动态绑定方法表。

比如定义以下的变量：

```java
class Demo {
    public static final int num1 = 1;
    public static int num2 = 1;
}
```

以上一个是静态变量，一个是静态常量，其中 `num1` 静态常量在编译时就确定了，其值存储于常量池中，在准备阶段赋值给 `num1`。而另一个 `num2` 静态变量，由于可以更改，所以无法确定值，所以是在 `clinit` 方法执行时赋值的。
